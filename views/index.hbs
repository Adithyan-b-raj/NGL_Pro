<div class="container admin-theme">
    <div class="header">
        <h1>Anonymous Chat</h1>
    </div>
    
    <div class="content">
        {{#if (lookup (query) 'success')}}
            <div class="alert alert-success">
                Message sent!
            </div>
        {{/if}}
        
        {{#if (lookup (query) 'error')}}
            <div class="alert alert-error">
                {{#if (eq (lookup (query) 'error') 'empty')}}
                    Please enter a message
                {{else}}
                    Failed to send message
                {{/if}}
            </div>
        {{/if}}
        
        {{#if messages}}
            <div class="messages">
                {{#each messages}}
                    <div class="message {{#if is_admin_reply}}admin{{else}}user{{/if}}">
                        <p class="message-content">{{message}}</p>
                    </div>
                    <div class="message-time">{{formatDate created_at}}</div>
                {{/each}}
            </div>
        {{else}}
            <div class="empty-state">
                <p>ðŸ‘‹ Start the conversation by sending your first anonymous message!</p>
            </div>
        {{/if}}
        
        <div class="message-form">
            <form method="POST" action="/send-message" id="messageForm">
                <div class="form-group">
                    <label for="message">Your Anonymous Message:</label>
                    <div class="message-input-container">
                        <textarea name="message" id="message" placeholder="Message..." required rows="1"></textarea>
                        <button type="submit" class="btn">âž¤</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-resize textarea
const textarea = document.getElementById('message');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
});

// Auto-scroll to bottom
const messages = document.querySelector('.messages');
if (messages) {
    messages.scrollTop = messages.scrollHeight;
}

// Auto-refresh for new messages every 3 seconds
setInterval(function() {
    // Only refresh if we're on the main page and not actively typing
    if (window.location.pathname === '/' && document.activeElement !== textarea) {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(html, 'text/html');
                const newMessages = newDoc.querySelector('.messages');
                const currentMessages = document.querySelector('.messages');
                
                if (newMessages && currentMessages) {
                    // Only update if content changed
                    if (newMessages.innerHTML !== currentMessages.innerHTML) {
                        currentMessages.innerHTML = newMessages.innerHTML;
                        currentMessages.scrollTop = currentMessages.scrollHeight;
                    }
                } else if (newMessages && !currentMessages) {
                    // First message received, reload page
                    window.location.reload();
                }
            })
            .catch(error => console.log('Auto-refresh error:', error));
    }
}, 3000);
</script>